<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- åŠ¨æ€favicon -->
    <link rel="icon" href="" type="image/x-icon" id="dynamic-favicon">
    <title id="dynamic-title">Merge Game</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            background-size: cover;
            background-position: center;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* é€šç”¨å›¾ç‰‡ä¿æŠ¤æ ·å¼ */
        img,iframe {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .game-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 100vw;
            max-height: 100vh;
        }

        #game-frame {
            width: 100vw;
            height: 100vh;
            border: none;
        }

        /* æ°´æœç´ æå±•ç¤ºåŒºåŸŸ */
        .fruit-materials {
            position: absolute;
            top: 0;
            left: -10px;
            transform: translateX(-100%);
            height: 100%;
            box-sizing: border-box;
            display: grid;
            grid-template-rows: repeat(11, 1fr);
            gap: 12px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            max-height: 667px;
            overflow-y: auto;
        }

        .fruit-item {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden; 
            border-radius: 50%;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }

        .fruit-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            transition: transform 0.3s ease;
            /* é˜²æ­¢å›¾ç‰‡è¢«æ‹–åŠ¨ã€ä¸‹è½½ã€å³é”®èœå•ç­‰ */
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            pointer-events: none;
        }

        .fruit-image:hover {
            transform: scale(1.1);
        }

        /* æ°´æœæ»¤é•œæ•ˆæœ */
        .fruit-gray {
            filter: grayscale(100%);
            transition: filter 0.5s ease-in-out;
        }


        /* å½“å±å¹•å®½åº¦å¤§äºç­‰äº500pxæ—¶ï¼Œåº”ç”¨PCç«¯æ ·å¼ */
        @media (min-width: 500px) {
            #game-frame {
                width: 375px;
                height: 667px;
                max-height: 95vh; /* ç¡®ä¿iframeåœ¨å‚ç›´æ–¹å‘ä¸Šä¸ä¼šè¶…å‡ºå±å¹• */
                border-radius: 20px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .fruit-materials {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
                grid-template-rows: none;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 10px;
            }
            
            .fruit-image {
                width: 100%;
                height: 100%;
            }
            
        }

        @media (max-width: 480px) {
            .fruit-materials {
                display: none; /* åœ¨å°å±å¹•ä¸Šéšè—ç´ æåŒºåŸŸ */
            }
        }

        /* è§’è‰²è§£é”å±•ç¤ºæ•ˆæœæ ·å¼ */
        .unlock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .unlock-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .unlock-content {
            background: transparent;
            border-radius: 0;
            padding: 0;
            text-align: center;
            box-shadow: none;
            transform: scale(0.8);
            transition: transform 0.3s ease;
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }

        /* 8æ¡æ”¾å°„å…‰çº¿ */
        .rays {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300vw; /* è¶…è¿‡è§†å£ */
            height: 300vh;
            background: repeating-conic-gradient(
                white 0deg 22.5deg,
                transparent 22.5deg 45deg
            );
            transform: translate(-50%, -50%);
            border-radius: 50%;
            animation: spin 8s linear infinite;
            opacity: 0.4;
            z-index: 0;
        }


        .unlock-overlay.show .unlock-content {
            transform: scale(1);
        }

        .unlock-fruit-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
            border-radius: 50%;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            margin: 0;
            animation: bounceIn 0.6s ease;
            position: relative;
            z-index: 2;
            /* é˜²æ­¢å›¾ç‰‡è¢«æ‹–åŠ¨ã€ä¸‹è½½ã€å³é”®èœå•ç­‰ */
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            pointer-events: none;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.8;
            }
            50% {
                opacity: 0.4;
            }
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }


        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .unlock-fruit-image {
                width: 120px;
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <iframe id="game-frame" src="index-iframe.html"></iframe>
        
        <!-- æ°´æœç´ æå±•ç¤ºåŒºåŸŸ -->
        <div class="fruit-materials">
            <div class="fruit-item" id="fruit-0">
                <img src="res/assets-online/1.png" alt="item_1" class="fruit-image">
            </div>

            <div class="fruit-item" id="fruit-1">
                <img src="res/assets-online/2.png" alt="item_2" class="fruit-image fruit-gray">
            </div>

            <div class="fruit-item" id="fruit-2">
                <img src="res/assets-online/3.png" alt="item_3" class="fruit-image fruit-gray">
            </div>

            <div class="fruit-item" id="fruit-3">
                <img src="res/assets-online/4.png" alt="item_4" class="fruit-image fruit-gray">
            </div>

            <div class="fruit-item" id="fruit-4">
                <img src="res/assets-online/5.png" alt="item_5" class="fruit-image fruit-gray">
            </div>

            <div class="fruit-item" id="fruit-5">
                <img src="res/assets-online/6.png" alt="item_6" class="fruit-image fruit-gray">
            </div>

            <div class="fruit-item" id="fruit-6">
                <img src="res/assets-online/7.png" alt="item_7" class="fruit-image fruit-gray">
            </div>

            <div class="fruit-item" id="fruit-7">
                <img src="res/assets-online/8.png" alt="item_8" class="fruit-image fruit-gray">
            </div>

            <div class="fruit-item" id="fruit-8">
                <img src="res/assets-online/9.png" alt="item_9" class="fruit-image fruit-gray">
            </div>

            <div class="fruit-item" id="fruit-9">
                <img src="res/assets-online/10.png" alt="item_10" class="fruit-image fruit-gray">
            </div>

            <div class="fruit-item" id="fruit-10">
                <img src="res/assets-online/11.png" alt="item_11" class="fruit-image fruit-gray">
            </div>
        </div>
    </div>
    
    <!-- è§’è‰²è§£é”å±•ç¤ºæ•ˆæœ -->
    <div class="unlock-overlay" id="unlockOverlay">
        <div class="unlock-content">
            <div class="rays"></div>
            <img id="unlockFruitImage" src="" alt="" class="unlock-fruit-image">
        </div>
    </div>
    
    <script>
        // æ°´æœåç§°æ˜ å°„ï¼ˆä¸æ¸¸æˆä¸­çš„é¡ºåºä¸€è‡´ï¼‰
        const fruitNames = ["è‘¡è„", "æ¨±æ¡ƒ", "è‰è“", "æ©˜å­", "æŸ æª¬", "çŒ•çŒ´æ¡ƒ", "è è", "æ¤°å­", "è¥¿ç“œ", "åŠä¸ªè¥¿ç“œ"];
        
        // å·²è§£é”çš„æ°´æœçŠ¶æ€ï¼ˆå†…å­˜ä¸­è®°å½•ï¼Œé¡µé¢åˆ·æ–°åé‡ç½®ï¼‰
        const unlockedFruits = new Set();
        
        // ç”Ÿæˆæ ‡ç­¾é¡µå”¯ä¸€æ ‡è¯†ç¬¦
        function generateTabId() {
            let tabId = sessionStorage.getItem('gameTabId');
            if (!tabId) {
                tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('gameTabId', tabId);
            }
            return tabId;
        }
        
        // å½“å‰æ ‡ç­¾é¡µID
        const currentTabId = generateTabId();
        
        // æ ¹æ®åˆæˆç»“æœæ›´æ–°æ»¤é•œ
        function updateFruitFilter(fruitName, source = 'unknown') {
            const fruitIndex = fruitNames.indexOf(fruitName);
            if (fruitIndex !== -1) {
                const fruitItem = document.querySelector(`#fruit-${fruitIndex}`);
                if (fruitItem) {
                    const fruitImage = fruitItem.querySelector('.fruit-image');
                    if (fruitImage) {
                        // ç§»é™¤ç°è‰²æ»¤é•œï¼Œæ­£å¸¸æ˜¾ç¤º
                        fruitImage.classList.remove('fruit-gray');
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºé¦–æ¬¡è§£é”
                        checkAndShowUnlockEffect(fruitName, fruitIndex, source);
                    }
                }
            }
        }

        // æ£€æŸ¥å¹¶æ˜¾ç¤ºè§£é”æ•ˆæœ
        function checkAndShowUnlockEffect(fruitName, fruitIndex, source = 'unknown') {
            const isFirstUnlock = !unlockedFruits.has(fruitIndex);
            
            if (isFirstUnlock) {
                // è®°å½•ä¸ºå·²è§£é”
                unlockedFruits.add(fruitIndex);
                
                // ç‰¹æ®Šå¤„ç†é€»è¾‘
                if (fruitIndex === 0) {
                    // ç¬¬ä¸€ä¸ªæ°´æœï¼ˆè‘¡è„ï¼‰ï¼šç›´æ¥ç‚¹äº®ï¼Œæ— ç‰¹æ•ˆ
                    return;
                } else if (fruitIndex === 9) {
                    // æœ€åä¸€ä¸ªæ°´æœï¼ˆåŠä¸ªè¥¿ç“œï¼‰ï¼šç‚¹äº®+å½©è‰²ï¼Œæ— æ’’èŠ±ç‰¹æ•ˆ
                    console.log('ğŸ‰ æœ€åä¸€ä¸ªæ°´æœè§£é”ï¼Œç‚¹äº®ä½†æ— æ’’èŠ±ç‰¹æ•ˆ');
                    return;
                } else if (source === 'generate') {
                    // è‡ªåŠ¨ç”Ÿæˆçš„æ°´æœï¼šç›´æ¥ç‚¹äº®ï¼Œæ— æ’’èŠ±ç‰¹æ•ˆ
                    console.log(`ğŸ è‡ªåŠ¨ç”Ÿæˆæ°´æœ ${fruitName} è§£é”ï¼Œç›´æ¥ç‚¹äº®`);
                    return;
                } else if (source === 'merge') {
                    // ç”¨æˆ·åˆæˆçš„æ°´æœï¼šæ˜¾ç¤ºè§£é”ç‰¹æ•ˆ
                    showUnlockEffect(fruitName, fruitIndex);
                }
            }
        }

        // æ˜¾ç¤ºè§£é”æ•ˆæœ
        function showUnlockEffect(fruitName, fruitIndex) {
            const overlay = document.getElementById('unlockOverlay');
            const fruitImage = document.getElementById('unlockFruitImage');
            
            // åŠ¨æ€è·å–æ°´æœå›¾ç‰‡è·¯å¾„
            const fruitImagePaths = [
                buildAssetPath('1.png'),   // è‘¡è„ (fruit-0)
                buildAssetPath('2.png'),   // æ¨±æ¡ƒ (fruit-1)
                buildAssetPath('3.png'),   // æ©˜å­ (fruit-2)
                buildAssetPath('4.png'),   // æŸ æª¬ (fruit-3)
                buildAssetPath('5.png'),   // çŒ•çŒ´æ¡ƒ (fruit-4)
                buildAssetPath('6.png'),   // è¥¿çº¢æŸ¿ (fruit-5)
                buildAssetPath('7.png'),   // æ¡ƒ (fruit-6)
                buildAssetPath('8.png'),   // è è (fruit-7)
                buildAssetPath('9.png'),   // æ¤°å­ (fruit-8)
                buildAssetPath('10.png'),  // è¥¿ç“œ (fruit-9)
                buildAssetPath('11.png')   // å¤§è¥¿ç“œ (fruit-10)
            ];
            
            // è®¾ç½®æ°´æœå›¾ç‰‡
            fruitImage.src = fruitImagePaths[fruitIndex] || fruitImagePaths[0];
            fruitImage.alt = fruitName;
            
            // æ˜¾ç¤ºé®ç½©å±‚
            overlay.classList.add('show');
            
            // åˆ›å»ºæ’’èŠ±ç‰¹æ•ˆ
            createConfetti();
            
            // è®¾ç½®è‡ªåŠ¨å…³é—­å®šæ—¶å™¨ï¼ˆ3ç§’ï¼‰
            const autoCloseTimer = setTimeout(() => {
                hideUnlockEffect();
            }, 3000);
            
            // ç‚¹å‡»å…³é—­äº‹ä»¶
            overlay.addEventListener('click', function closeHandler(e) {
                // æ¸…é™¤è‡ªåŠ¨å…³é—­å®šæ—¶å™¨
                clearTimeout(autoCloseTimer);
                hideUnlockEffect();
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
                overlay.removeEventListener('click', closeHandler);
            });
        }

        // åˆ›å»ºæ’’èŠ±ç‰¹æ•ˆ
        function createConfetti() {
            // å…¨å±æ’’èŠ±æ•ˆæœ - ä»å±å¹•é¡¶éƒ¨å¼€å§‹
            confetti({
                particleCount: 200,
                spread: 100,
                origin: { y: 0 },
                zIndex: 10000
            });
            
            // å…¨å±æ’’èŠ±æ•ˆæœ - ä»å±å¹•ä¸­å¤®å¼€å§‹
            confetti({
                particleCount: 150,
                spread: 120,
                origin: { y: 0.5 },
                zIndex: 10000
            });
            
            // å…¨å±æ’’èŠ±æ•ˆæœ - ä»å±å¹•åº•éƒ¨å¼€å§‹
            confetti({
                particleCount: 100,
                spread: 100,
                origin: { y: 1 },
                zIndex: 10000
            });
        }

        // éšè—è§£é”æ•ˆæœ
        function hideUnlockEffect() {
            const overlay = document.getElementById('unlockOverlay');
            overlay.classList.remove('show');
        }

        // é€šä¿¡ç­–ç•¥ï¼šä¼˜å…ˆä½¿ç”¨PostMessageï¼ˆiframeé€šä¿¡ï¼Œå¤©ç„¶éš”ç¦»å¤šæ ‡ç­¾é¡µï¼‰
        let channel = null;
        let usePostMessage = true; // é»˜è®¤ä½¿ç”¨PostMessage
        
        // æ£€æµ‹BroadcastChannelæ”¯æŒæƒ…å†µï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
        if (typeof BroadcastChannel !== 'undefined') {
            try {
                channel = new BroadcastChannel('fruit-merge-channel');
            } catch (error) {
                console.warn('BroadcastChannel åˆå§‹åŒ–å¤±è´¥:', error);
            }
        } else {
            console.log('æµè§ˆå™¨ä¸æ”¯æŒ BroadcastChannelï¼Œä½¿ç”¨ PostMessage æ–¹æ¡ˆ');
        }

        // æ¶ˆæ¯å¤„ç†å‡½æ•°
        function handleMessage(event) {
            // éªŒè¯æ¶ˆæ¯æ¥æºæ ‡ç­¾é¡µIDï¼ˆé¿å…å¤šæ ‡ç­¾é¡µå¹²æ‰°ï¼‰
            if (event.data.senderTabId && event.data.senderTabId !== currentTabId) {
                return;
            }
            
            if (event.data.type === 'fruitMerge') {
                const data = event.data.data;
                
                // æ›´æ–°åˆæˆç»“æœçš„æ»¤é•œ
                updateFruitFilter(data.result, data.source || 'merge');
            } else if (event.data.type === 'fruitGenerate') {
                const data = event.data.data;
                
                // æ›´æ–°ç”Ÿæˆæ°´æœçš„æ»¤é•œï¼ˆç‚¹äº®å·¦ä¾§åˆ—è¡¨ï¼‰
                updateFruitFilter(data.fruitName, data.source || 'generate');
            }
        }

        // ç›‘å¬æ°´æœåˆæˆå’Œç”Ÿæˆæ¶ˆæ¯
        if (channel) {
            channel.addEventListener('message', handleMessage);
        }
        
        // PostMessage ä¸»è¦é€šä¿¡æ–¹æ¡ˆï¼ˆiframeé€šä¿¡ï¼Œå¤©ç„¶éš”ç¦»å¤šæ ‡ç­¾é¡µï¼‰
        window.addEventListener('message', function(event) {
            // éªŒè¯æ¶ˆæ¯æ¥æºï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰
            if (event.origin !== window.location.origin) {
                return;
            }
            
            // éªŒè¯æ¶ˆæ¯æ˜¯å¦æ¥è‡ªiframe
            const iframe = document.getElementById('game-frame');
            if (iframe && event.source !== iframe.contentWindow) {
                return;
            }
            
            handleMessage(event);
        });

        // é¡µé¢å¸è½½æ—¶å…³é—­é¢‘é“
        window.addEventListener('beforeunload', function() {
            if (channel) {
                channel.close();
            }
        });

        // é˜²æ­¢å›¾ç‰‡è¢«å³é”®ç‚¹å‡»ã€æ‹–æ‹½ç­‰æ“ä½œ
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸ºæ‰€æœ‰å›¾ç‰‡æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                // é˜²æ­¢å³é”®èœå•
                img.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                // é˜²æ­¢æ‹–æ‹½å¼€å§‹
                img.addEventListener('dragstart', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                // é˜²æ­¢æ‹–æ‹½
                img.addEventListener('drag', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                // é˜²æ­¢æ‹–æ‹½ç»“æŸ
                img.addEventListener('dragend', function(e) {
                    e.preventDefault();
                    return false;
                });
            });
        });
    </script>

    <!-- åŠ¨æ€èƒŒæ™¯è®¾ç½®å’Œiframeå‚æ•°ä¼ é€’ -->
    <script>
        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰èµ„æºåŒ…åç§°
        let currentAssetPack = 'merge-melon';

        // æ„å»ºåŠ¨æ€èµ„æºè·¯å¾„çš„å‡½æ•°
        function buildAssetPath(filename) {
            return `assets/${currentAssetPack}/${filename}`;
        }

        // æ ¼å¼åŒ–ç´ æåŒ…åç§°ä¸ºæ ‡é¢˜
        function formatPackNameToTitle(packName) {
            return packName
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // åŠ¨æ€è®¾ç½®èƒŒæ™¯å›¾ç‰‡å’Œiframeå‚æ•°
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            currentAssetPack = urlParams.get('assets') || 'merge-melon';

            // è®¾ç½®åŠ¨æ€æ ‡é¢˜
            const gameTitle = formatPackNameToTitle(currentAssetPack);
            const titleElement = document.getElementById('dynamic-title');
            if (titleElement) {
                titleElement.textContent = gameTitle;
            }

            // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
            const backgroundPath = buildAssetPath('background.png');
            document.body.style.backgroundImage = `url('${backgroundPath}')`;

            // è®¾ç½®åŠ¨æ€favicon
            const faviconPath = buildAssetPath('favicon.png');
            const faviconLink = document.getElementById('dynamic-favicon');
            if (faviconLink) {
                faviconLink.href = faviconPath;
            }

            // ä¼ é€’å‚æ•°ç»™iframe
            const iframe = document.getElementById('game-frame');
            if (iframe) {
                const iframeSrc = `index-iframe.html?assets=${encodeURIComponent(currentAssetPack)}`;
                iframe.src = iframeSrc;
            }

            // æ›´æ–°æ‰€æœ‰æ°´æœå›¾ç‰‡è·¯å¾„
            updateFruitImages();
        });

        // æ›´æ–°æ°´æœå›¾ç‰‡è·¯å¾„
        function updateFruitImages() {
            for (let i = 0; i < 11; i++) {
                const fruitImg = document.querySelector(`#fruit-${i} img`);
                if (fruitImg) {
                    fruitImg.src = buildAssetPath(`${i + 1}.png`);
                }
            }
        }
    </script>

    <!-- æ’’èŠ±ç‰¹æ•ˆåº“ -->
    <script src="src/confetti.js"></script>
</body>
</html>
